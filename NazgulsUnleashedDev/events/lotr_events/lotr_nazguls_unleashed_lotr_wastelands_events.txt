namespace = wastelands_nazguls

## Called from yearly events to check if AI should colonise
## For human player version check scripted_guis/lotr_wastelands.txt -> gui_colonise
wastelands_nazguls.0006 = {	
	hidden = yes
	scope = character	

	trigger = {
		###
		### Basic checks
		###
		is_ai = yes
		is_independent_ruler = yes
		
		###
		### Culture/Character ID triggers
		###
		NOR = { #Stop Sauron colonising
			is_sauron = yes
			has_title = title:e_mordor
		}
		is_in_valinor = no
		NOT = { this = character:linesteward38 }
		NOT = { has_culture = culture:wastelands }

		###
		### Character Income Trigger
		###

		trigger_if = { # If count
			limit = { highest_held_title_tier = tier_county }
			gold >= 50
			monthly_character_income >= 2
		}
		trigger_else_if = { # If duke
			limit = { highest_held_title_tier = tier_duchy }
			gold >= 75
			monthly_character_income >= 1.75
		}
		trigger_else_if = { # If king
			limit = { highest_held_title_tier = tier_kingdom }
			gold >= 100
			monthly_character_income >= 1.75
		}
		trigger_else_if = { # If emporer
			limit = { highest_held_title_tier = tier_empire }
			gold >= 125
			monthly_character_income >= 1.5
		}
		trigger_else = { gold >= 150 } # Fallback

		###
		### Only surrounding lands
		###
		any_sub_realm_county = {
			any_title_to_title_neighboring_and_across_water_county = {
				culture = culture:wastelands
				NOT = { has_county_modifier = block_settlement_ability }
			}
		}


		###
		### Check whether the ruler is above their settlement limit
		###
		above_settlement_limit = no

		
		###
		### Check, dependent on game rules, who can colonize
		### 

		trigger_if = { #default game rules
			limit = { has_game_rule = default_colonisation_speed }
			root = character:nazgul9 # Ovatha Can colonise from the start
		}

	}
	immediate = {
		debug_log = "wastelands_nazguls.0006: AI considering colonization..."
		
		### MAKING LIST OF APPROPRIATE COUNTIES TO BE COLONISED PER GAME RULE ###
		if = { # GAME RULE --> default_colonisation_speed
			limit = { has_game_rule = default_colonisation_speed }

			### OVATHA ###
			if = {## COUNTIES AVAILABLE FOR NAZGUL AI ##
				limit = { root = character:nazgul9 }
				debug_log = "wastelands_nazguls.0006: Nazgul List Made"
				every_sub_realm_county = {
					every_title_to_title_neighboring_and_across_water_county = {
						limit = {
							culture = culture:wastelands
							this = { save_temporary_scope_as = target }
							NOR = {
								has_county_modifier = block_settlement_ability
								holder = root
							}
							OR = {
								title:e_greenwood = { is_de_jure_liege_or_above_target = scope:target }
								title:k_ehwathrumavuld = { is_de_jure_liege_or_above_target = scope:target }
								title:k_brownlands = { is_de_jure_liege_or_above_target = scope:target }
							}
						}
						add_to_list = adjacent_wastelands
					}
				}
			}
		}
		if = { # GAME RULE --> weighted_colonisation_speed
			limit = { has_game_rule = weighted_colonisation_speed }

			### NAZGUL ###
			if = { ## COUNTIES AVAILABLE FOR NAZGUL AI ##
				limit = { root = character:nazgul9 }
				debug_log = "wastelands_nazguls.0006: Nazgul List Made"
				every_sub_realm_county = {
					limit = { NOT = { culture = culture:wastelands } }
					every_title_to_title_neighboring_and_across_water_county = {
						limit = {
							culture = culture:wastelands
							NOR = {
								has_county_modifier = block_settlement_ability
								holder = root
							}
							title_province ?= { NOT = { terrain = halls } }
						}
						add_to_list = adjacent_wastelands
					}
				}
			}
		}
		if = { # GAME RULE --> normal_colonisation_speed
			limit = { has_game_rule = normal_colonisation_speed }
			if = {
				limit = {
					OR = {
						is_dwarf = yes
						is_orc = yes
						is_nazgul = yes
						is_istari = yes
						is_maiar = yes
					}
				}
				every_sub_realm_county = {
					every_title_to_title_neighboring_and_across_water_county = {
						limit = {
							culture = culture:wastelands
							NOR = {
								has_county_modifier = block_settlement_ability
								holder = root
							}
						}
						add_to_list = adjacent_wastelands
					}
				}
			} 
			else = {
				every_sub_realm_county = {
					limit = { NOT = { culture = culture:wastelands } }
					every_title_to_title_neighboring_and_across_water_county = {
						limit = {
							culture = culture:wastelands
							NOR = {
								has_county_modifier = block_settlement_ability
								holder = root
							}
							title_province ?= { NOT = { terrain = halls } }
						}
						add_to_list = adjacent_wastelands
					}
				}
			}
		}

		ordered_in_list = {
			list = adjacent_wastelands
			order_by = {
				value = 0
				every_neighboring_county = { 
					limit = { holder = root }
					add = 2
				}
				every_neighboring_county = { 
					limit = { 
						holder = root 
						duchy = prev.duchy
					}
					add = 16
				}
				every_neighboring_county = { 
					limit = { 
						holder = root 
						kingdom = prev.kingdom
					}
					add = 8
				}
				every_neighboring_county = { 
					limit = { 
						holder = root 
						empire = prev.empire
					}
					add = 4
				}
			}
			save_scope_as = wastelands
		}

		### MAKE AI COLONISE COUNTY ###
		scope:wastelands ?= { debug_log_scopes = yes } # Only needed for testing
		if = {
			limit = { exists = scope:wastelands }
			ai_colonisation_effect = { WASTELANDS = scope:wastelands }
		}		
	}
}